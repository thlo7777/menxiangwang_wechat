<?php

define('MENU_WECHAT_PY_SHOPPING', 'menu-py-shopping');

/**
 * hook_permission()
 */
function wechat_py_shopping_permission() {
  return array(
    'wechat py shopping module permission' => array(
      'title' => t('Access wechat py shopping module'),
      'description' => t('访问梦乡平遥游商城管理模块'),
    ),
    'wechat py commodity order information' => array(
      'title' => t('微信平遥商品订单信息权限'),
      'description' => t('管理商品订单信息权限'),
    ),
  );
}

/**
 * Implements hook_ctools_plugin_directory().
 *
 * It simply tells panels where to find the .inc files that define various
 * args, contexts, content_types. In this case the subdirectories of
 * ctools_plugin_example/panels are used.
 */
function wechat_py_shopping_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}

/**
 * Implements hook_block_info().
 */
function wechat_py_shopping_block_info() {

  $blocks['wechat_content_type_list'] = array(
    'info' => t('微信平台内容录入列表'),
    'weight' => 100,
  );

  return $blocks;
}

/**
 * Implement hook_block_view($delta = '')
 **/
function wechat_py_shopping_block_view($delta = '') {
  switch ($delta) {
    case 'wechat_content_type_list':
      // The subject is displayed at the top of the block. Note that it
      // should be passed through t() for translation. The title configured
      // for the block using Drupal UI supercedes this one.
      $block['subject'] = t('内容录入列表');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = wechat_content_type_list_contents($delta);
      return $block;
      break;
  }
}

/**
 * A module-defined block content function.
 */
function wechat_content_type_list_contents($which_block) {
  $element = array();
  $items_shopping = array();

  switch ($which_block) {
    case 'wechat_content_type_list':
      //find content type for node add
      $item = menu_get_item('node/add');
      $content = system_admin_menu_block($item);
      //dpm($content);
      foreach ($content as $id => $menu) {
        if (preg_match('/.*merchandise-input-ct$/', $menu['link_path']) ||
            //preg_match('/.*merchandise-discount-rule-ct$/', $menu['link_path']) ||
            //preg_match('/.*merchandise-discount-rule-ct-1$/', $menu['link_path']) ||
            //preg_match('/.*merchandise-common-discount-rule$/', $menu['link_path']) ||
            preg_match('/.*merchandise-points-rule-ct$/', $menu['link_path']) ||
            preg_match('/.*mobile-shopping-adv-node$/', $menu['link_path']) ||
            preg_match('/.*express-template-ct$/', $menu['link_path'])
            ) {

          if (empty($element['shopping_ct_field_set'])) {
            $element['shopping_ct_field_set'] = array(
              '#type' => 'fieldset',
              '#title' => t('微商城内容'), 
              '#weight' => 11, 
            );
          }
          $link = array(
            '#type' => 'link',
            '#title' => $menu['link_title'],
            '#href' => $menu['href'],
          );
          if (preg_match('/.*merchandise-input-ct$/', $menu['link_path'])) {
            //put merchandise input to first data in array
            $items_shopping[0] = drupal_render($link);
          } else {
            $items_shopping[$menu['mlid']] = drupal_render($link);
          }
        }

      }

      //sort merchandise input node to first in array
      ksort($items_shopping);
      if (!empty($element['shopping_ct_field_set'])) {
        $element['shopping_ct_field_set']['list'] = array(
          '#theme' => 'item_list',
          '#items' => $items_shopping,
          '#attributes' => array('style' => array('list-style: none; padding: 0px;'),
                                 'class' => array('wechat-content-type-list'),
          ),
        );
      }

      drupal_add_css('.wechat-content-type-list a.active{color: #2FA4E7;}', array('type' => 'inline'));

      return $element;
      break;
  }

}

/**
 * Implements hook_menu()
 */
function wechat_py_shopping_menu(){
  
  $items['wechat-py-shopping'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '梦乡平遥游商城管理主页面',
    'page callback' => 'menu_wechat_py_shopping_form',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'expanded' => TRUE,
    'weight' => 0,
  );

/*
  $items['wechat-py-shopping/merchant-list'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '微商城商品目录页面',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_py_shopping_merchant_list_form'),
    'description' => '商品浏览页面',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 1,
    'file' => 'menu_wechat_py_shopping_merchant_input_form.inc',
  );
*/

  $items['wechat-py-shopping/merchant-input'] = array(
    'type' => MENU_CALLBACK,
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '微商城商品录入',
    'page callback' => 'menu_wechat_py_shopping_merchant_input_form',
    'description' => '商品输入页面',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 1,
    'file' => 'menu_wechat_py_shopping_merchant_input_form.inc',
  );

  $items['wechat-py-shopping/commodity-category'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '微商城商品分类表',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_py_commodity_category_page_form'),
    'description' => '商品分类表',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 2,
    'file' => 'menu_wechat_py_commodity_category_page_form.inc',
  );

/*
  $items['wechat-py-shopping/adv-management'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '商城广告页面管理',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_py_shopping_adv_page_form'),
    'description' => '设置广告页面',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 3,
    'file' => 'wechat_py_shopping_adv_page_form.inc',
  );
*/

  $items['wechat-py-shopping/commodity-category/add'] = array(
  //$items['wechat-py-shopping/commodity-category/add/%/%'] = array(
    //found a bug, the type should be put to first element of array, otherwise the menu dosn't work
    'type' => MENU_CALLBACK,
    //'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '编辑商品分类',
    //'page callback' => 'drupal_get_form',
    'page callback' => 'menu_wechat_py_commodity_category_page_add_form',
    //use drupal category term
    //'page arguments' => array('menu_wechat_py_commodity_category_page_add_form'),
    // '1' being the 2nd position in the path. 0/1
    //'page arguments' => array('menu_wechat_py_commodity_category_page_add_form', 3, 4),
    'description' => '增加商品分类',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 3,
    'file' => 'menu_wechat_py_commodity_category_page_form.inc',
  );

  /*$items['wechat-py-shopping/wechat-merchant-group'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '微信小店商品分组管理',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_merchant_group_form'),
    'description' => '微信小店商品分组管理页面',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 4,
    'file' => 'wechat_merchant_group_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-group/add'] = array(
    'type' => MENU_CALLBACK,
    'title' => '增加分组信息',
    'page callback' => 'menu_wechat_merchant_group_add_form',
    'description' => '微信小店商品分组管理页面',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 5,
    'file' => 'wechat_merchant_group_form.inc',
  );*/

  $items['wechat-py-shopping/wechat-merchant-shelf'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '微信小店货架管理页面',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_merchant_shelf_form'),
    'description' => '微信小店商品货架管理页面',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 6,
    'file' => 'wechat_merchant_shelf_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-category'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '微信小店商品分类页面',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_merchant_category_form'),
    'description' => '微信小店商品分类管理页面',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 7,
    'file' => 'wechat_merchant_category_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '微商城邮费模版页面',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_merchant_express_root_form'),
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 8,
    'file' => 'wechat_merchant_express_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express/list'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '邮费模版列表',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_merchant_express_list_form'),
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 9,
    'file' => 'wechat_merchant_express_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express/add'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '增加邮费模版',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_merchant_express_add_form'),
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 10,
    'file' => 'wechat_merchant_express_add_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express/%/delete'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'ctools_ajax_merchant_express_delete',
    'page arguments' => array(2),
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'file' => 'wechat_merchant_express_add_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express/%/edit'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_merchant_express_edit_form', 2),
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'file' => 'wechat_merchant_express_edit_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express/%/add-item'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_wechat_merchant_express_add_item', 2),
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'file' => 'wechat_merchant_express_edit_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express/weight-section'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => '快递重量价格设置',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_weight_section_form'),
    'description' => '快递包裹重量区间设置页面',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 11,
    'file' => 'wechat_merchant_express_form.inc',
  );

/*
  $items['wechat-py-shopping/wechat-merchant-express/weight-section/%/delete'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'ctools_ajax_merchant_express_weight_section_delete',
    'page arguments' => array(3),
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'file' => 'wechat_merchant_express_form.inc',
  );
*/

  $items['wechat-py-shopping/wechat-merchant-express/form-test'] = array(
    'menu_name' => MENU_WECHAT_PY_SHOPPING,
    'title' => 'form test',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('menu_weight_form_test_form'),
    'description' => 'form page test',
    'access callback' => 'user_access',
    'access arguments' => array('wechat py shopping module permission'),
    'weight' => 30,
    'expanded' => TRUE,
    'file' => 'wechat_merchant_express_form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express/form-test/ajax-remove'] = array(
    'type' => MENU_CALLBACK,
    'title' => 'Remove item callback',
    'page callback' => 'form_test_ajax_remove_js',
    'delivery callback' => 'ajax_deliver',
    'access callback' => TRUE,
    'theme callback' => 'ajax_base_page_theme',
    'file path' => 'includes',
    'file' => 'form.inc',
  );

  $items['wechat-py-shopping/wechat-merchant-express/form-test/ajax-json'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'form_test_ajax_json_data',
    'access callback' => TRUE,
    'access arguments' => array('access content'),
    'file' => 'wechat_merchant_express_form.inc',
  );
  return $items;
}

/**
 * test for background_process_start in wechat_merchant_category_form.inc. It's ok for me :)
 **/
function background_execute($data1, $data2) 
{
  watchdog('background_execute', 'data1 <pre>@data</pre>', array('@data' => print_r($data1, TRUE)));
  watchdog('background_execute', 'data2 <pre>@data</pre>', array('@data' => print_r($data2, TRUE)));
}

/*
 * form test ajax page call back
 */
function form_test_ajax_remove_js() {
  // drupal_html_id() very helpfully ensures that all html IDS are unique
  // on a page. Unfortunately what it doesn't realize is that the IDs
  // we are generating are going to replace IDs that already exist, so
  // this actually works against us.
  if (isset($_POST['ajax_html_ids'])) {
    unset($_POST['ajax_html_ids']);
  }

  list($form, $form_state, $form_id, $form_build_id, $commands) = ajax_get_form();
  //dpm($form, 'before process remove js');
  //dpm($form_state, 'before process remove js state');

  drupal_process_form($form['#form_id'], $form, $form_state);
  //dpm($form, 'after process remove js');
  //dpm($form_state, 'after process remove js state');

  // Get the information on what we're removing.
  $button = $form_state['triggering_element'];
  // Go two levels up in the form, to the whole widget.

  $element = drupal_array_get_nested_value($form, array_slice($button['#array_parents'], 0, 1));
  //dpm($element, 'remove js');

  //$form_state['complete form']['container'] = $form_state['container']; 
  //$form['container'] = $form_state['container'];
  //$element = $form_state['container'];
  // Now send back the proper AJAX command to replace it.
  $commands[] = ajax_command_replace('#ajax-wrapper-for-test', drupal_render($element));
  $return = array(
    '#type' => 'ajax',
    '#commands' => $commands,
  );

  // Because we're doing this ourselves, messages aren't automatic. We have
  // to add them.
  $messages = theme('status_messages');
  if ($messages) {
    $return['#commands'][] = ajax_command_prepend('#ajax-wrapper-for-test', $messages);
  }

  return $return;

}
/**
 * wechat api mange callback page function
 */
function menu_wechat_py_shopping_form(){
  $render_array = array();
  $render_array['header'] = array(
    '#markup' => t('欢迎进入梦乡平遥游商城管理模块'),
  );

  return $render_array;
}



/**
 * Implements hook_menu_alter().
 */
function wechat_py_shopping_menu_alter(&$items) {
  //dpm($items);
  //hide view tabs for all shopping terms
  if (!empty($items['taxonomy/term/%taxonomy_term/view'])) {
    //$items['taxonomy/term/%taxonomy_term/view']['type'] = MENU_CALLBACK;
    $items['taxonomy/term/%taxonomy_term/view']['access callback'] = 'shopping_user_roles';
  }
}

/**
 * implement custome permissions for shopping user roles to hide term view tab
 **/
function shopping_user_roles() {
  global $user;
  if (in_array('page_admin', array_values($user->roles)) || 
      in_array('微商城管理员', array_values($user->roles))) {
    return false;
  }
  return true;
}

/**
 * Implements hook_node_presave($node)
 **/
function wechat_py_shopping_node_presave($node) {
  //clear mobile shopping express template list when node express_template_ct modified
  if ($node->type == "express_template_ct") {
    //dpm($node);
    cache_clear_all('mobile_shopping_express_template_cache', 'cache', TRUE);
  }
}
 
/**
 * Implements hook_form_alter()
 */
function wechat_py_shopping_form_alter(&$form, &$form_state, $form_id){

  if ($form_id == 'taxonomy_overview_terms') {
    $v_name = $form['#vocabulary']->machine_name;
    switch ($v_name) {

      //for points vocbulary
      case 'wechat_shopping_merchant_points_vocabulary':
        if (!user_access('administrator')) {
          if ($form['#total_entries'] > 0) {
            foreach ($form as $key => $element) {
              if (preg_match('/^tid/', $key)) {
                //dpm($element);
                $form[$key]['view']['#href'] = $element['view']['#href'] . '/merchant_points_vocabulary';
              }
            }
          }
        }
        break;
      case 'wechat_shopping_merchantdise_discount_vocabulary':
        if (!user_access('administrator')) {
          if ($form['#total_entries'] > 0) {
            foreach ($form as $key => $element) {
              if (preg_match('/^tid/', $key)) {
                //dpm($element);
                $form[$key]['view']['#href'] = $element['view']['#href'] . '/merchantdise_discount_vocabulary';
              }
            }
          }
        }
        break;
      case 'wechat_shopping_express_template_vocabulary':
        if (!user_access('administrator')) {
          if ($form['#total_entries'] > 0) {
            foreach ($form as $key => $element) {
              if (preg_match('/^tid/', $key)) {
                //dpm($element);
                $form[$key]['view']['#href'] = $element['view']['#href'] . '/express_template_vocabulary';
              }
            }
          }
        }
        break;
    }
  }

  if($form_id == 'taxonomy_form_term'){

    $v_name = $form['#vocabulary']->machine_name;
    switch ($v_name) {

      case 'wechat_shopping_merchant_vocabulary':
      case 'wechat_shopping_merchant_points_vocabulary':
      case 'wechat_shopping_merchantdise_discount_vocabulary':
      case 'wechat_shopping_express_template_vocabulary':
        if (!user_access('administrator')) {
          //remove taxonomy breadcrumb term eidt for other roles
          drupal_add_css('.form-item-taxonomy-breadcrumb-path {display:none;}', array('type' => 'inline'));
        }

        if (is_array($form['#term']) && is_null($form['#term']['tid'])) {
          drupal_set_title('添加分类');
        } else {
          //delete will pass term object to form
          if (!is_object($form['#term']) && empty($form['delete'])) {
            drupal_set_title($form['#term']['name']);
          }
        }
        break;

      default:
        break;
    }

    //handle mobile_city_culture_vocabulary_xxx vocabulary
    if (preg_match('/^mobile_city_culture_vocabulary_/', $v_name)) {
      if (!user_access('administrator')) {
        //remove taxonomy breadcrumb term eidt for other roles
        drupal_add_css('.form-item-taxonomy-breadcrumb-path {display:none;}', array('type' => 'inline'));
      }

      if (is_array($form['#term']) && is_null($form['#term']['tid'])) {
        drupal_set_title('添加分类');
      } else {
        //delete will pass term object to form
        if (!is_object($form['#term']) && empty($form['delete'])) {
          drupal_set_title($form['#term']['name']);
        }
      }
    }
  }

  //for product input node
  if($form_id == 'mobile_shopping_product_input_node_form') {
    module_load_include('inc', 'wechat_py_shopping', 'menu_wechat_py_shopping_merchant_input_form');
    _merchant_input_form_alter($form, $form_state);
  }


}


/**
 * Implements hook_node_view_alter(&$build)
 **/
function wechat_py_shopping_node_view_alter(&$build){
  if($build['#bundle'] == 'mobile_shopping_product_input'){
    module_load_include('inc', 'wechat_py_shopping', 'menu_wechat_py_shopping_merchant_input_form');
    _merchant_input_node_view_alter($build);
  }
}


/*
 * Implement hook_taxonomy_term_presave($term)
 */
function wechat_py_shopping_taxonomy_term_presave($term) {

  if($term->vocabulary_machine_name == 'wechat_shopping_merchant_group') {
    $wrapper = entity_metadata_wrapper('taxonomy_term', $term);
    $value = $wrapper->field_group_id->value();

    module_load_include('inc', 'wechat_api', 'wechat_api_php5');
    //if group id is null, then add term to wechat
    if($value == null) {

      $req_url = t(
        variable_get('增加分组-分组管理接口-微信小店'),
        array('@ACCESS_TOKEN' => variable_get('access_token'))
      );

      $post['group_detail'] = array(
        'group_name' => $term->name,
        'product_list' => array(),
      );

      $json = json_encode($post,
                          JSON_HEX_TAG |
                          JSON_HEX_APOS |
                          JSON_HEX_AMP |
                          JSON_HEX_QUOT |
                          JSON_UNESCAPED_UNICODE);

      $result = wechat_php_curl_https_post($req_url, $json);
      if (!$result) {
        watchdog('wechat add merchant group info',
          'add group <' . $term->name . '> error in @line line:@filename',
          array(
            '@line' => __LINE__,
            '@filename' => __FILE__,
          ),
          $severity = WATCHDOG_ERROR);
        return;
      }

      $json_value = json_decode($result);

      if($json_value->errcode == 0) {
        //set group id into term
        $wrapper = entity_metadata_wrapper('taxonomy_term', $term);
        $wrapper->field_group_id->set($json_value->group_id);
      }else{
        watchdog('wechat add merchant group info',
          'errmsg <pre>@print_r</pre> in @line line @filename', 
          array(
            '@print_r' => print_r($json_value, TRUE),
            '@line' => __LINE__,
            '@filename' => __FILE__,
          ),
          $severity = WATCHDOG_ERROR);
        drupal_set_message('增加分组失败，请删除该分组后重新添加！', 'error');
      }

    }else{
      //update group
      $post = array(
        'group_id' => $value,
        'group_name' => $term->name,
      );

      $req_url = t(
        variable_get('修改分组-分组管理接口-微信小店'),
        array('@ACCESS_TOKEN' => variable_get('access_token'))
      );

      $json = json_encode($post,
                          JSON_HEX_TAG |
                          JSON_HEX_APOS |
                          JSON_HEX_AMP |
                          JSON_HEX_QUOT |
                          JSON_UNESCAPED_UNICODE);

      $result = wechat_php_curl_https_post($req_url, $json);
      if (!$result) {
        watchdog('wechat update merchant group info',
          'update group <' . $term->name . '> error in @line line:@filename',
          array(
            '@line' => __LINE__,
            '@filename' => __FILE__,
          ),
          $severity = WATCHDOG_ERROR);
        return;
      }

      $json_value = json_decode($result);

      if($json_value->errcode != 0) {
        watchdog('wechat update merchant group info',
          'errmsg <pre>@print_r</pre> in @line line @filename', 
          array(
            '@print_r' => print_r($json_value, TRUE),
            '@line' => __LINE__,
            '@filename' => __FILE__,
          ),
          $severity = WATCHDOG_ERROR);
        drupal_set_message('修改分组失败，请重新选择该分组进行修改！', 'error');
      }


    }
  }
}

/*
 *Implement hook_taxonomy_term_delete($term)
 */
function wechat_py_shopping_taxonomy_term_delete($term) {

  if($term->vocabulary_machine_name == 'wechat_shopping_merchant_group') {

    module_load_include('inc', 'wechat_api', 'wechat_api_php5');
    $req_url = t(
      variable_get('删除分组-分组管理接口-微信小店'),
      array('@ACCESS_TOKEN' => variable_get('access_token'))
    );

    $wrapper = entity_metadata_wrapper('taxonomy_term', $term);
    $value = $wrapper->field_group_id->value();

    $post['group_id'] = $value;
    $json = json_encode($post,
                        JSON_HEX_TAG |
                        JSON_HEX_APOS |
                        JSON_HEX_AMP |
                        JSON_HEX_QUOT |
                        JSON_UNESCAPED_UNICODE);
    $result = wechat_php_curl_https_post($req_url, $json);
    if (!$result) {
      watchdog('wechat delete merchant group info',
        'delete group <' . $term->name . '> error in @line line:@filename',
        array(
        '@line' => __LINE__,
        '@filename' => __FILE__,
        ),
        $severity = WATCHDOG_ERROR);
      return ;
    }

    $json_value = json_decode($result);

    if($json_value->errcode != 0) {
      watchdog('wechat delete merchant group info',
        'errmsg <pre>@print_r</pre> in @line line @filename', 
        array(
          '@print_r' => print_r($json_value, TRUE),
          '@line' => __LINE__,
          '@filename' => __FILE__,
        ),
        $severity = WATCHDOG_ERROR);
    }

  }
}


/**
 * Implements hook_libraries_info(). for wechat pay api library
 */
function wechat_py_shopping_libraries_info() {
  // This array key lets Libraries API search for 'sites/all/libraries/wxpayapi'
  // directory, which should contain the entire, original extracted library.
  $libraries['wxpayapi'] = array(
    'name' => 'wechat pay api php interface',

    'version arguments' => array(
      'file' => 'README.txt',
      'pattern' => '@Version ([0-9a-zA-Z\.-]+)@',
      'cols' => 14,
    ),

    'files' => array(
      // For PHP libraries, specify include files here, still relative to the
      // library path.
      'php' => array(
        'WxPay.JsApiPay.php',
        'lib/WxPay.Api.php',
        'lib/WxPay.Exception.php',
        'lib/WxPay.Config.php',
        'lib/WxPay.Data.php',
        'phpqrcode/phpqrcode.php',
      ),
    ),
  );


  //not work for mobile client so only remove to py mobile module
  /*
  //this array key for wechat jsapi 
  $libraries['wxjsapi'] = array(
    'name' => 'wechat mobile js api',

    'version' => '1.0.0',

    'files' => array(
      // For PHP libraries, specify include files here, still relative to the
      // library path.
      'js' => array(
        'Wxjsapi.js',
        'jweixin-1.0.0.js',
      ),
    ),
  );
  */

  return $libraries;
}

/**
 * Implementation of hook_views_api().
 */
function wechat_py_shopping_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'wechat_py_shopping') . '/views',
  );
}


/**
 * End of wechat py shopping module
 */
